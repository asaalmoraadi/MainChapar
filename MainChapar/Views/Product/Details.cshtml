
@model MainChapar.Models.Product
@using Microsoft.AspNetCore.Identity
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = "جزییات محصول";
    var comments = ViewBag.Comments as List<MainChapar.Models.Comment>;
    var similarProducts = ViewBag.SimilarProducts as List<MainChapar.Models.Product>;
    var user = UserManager.GetUserAsync(User).Result;
    Layout = "~/Views/Shared/_newLayout1.cshtml";
}

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CHAPAR</title>
    <link rel="stylesheet" href="~/assets/product/styles.css" />
</head>

<div class="container">
    <div class="product-page">
        <div class="image-section">
            <img src="~/assets/img/product/@Model.ImageName" class="main-img" id="mainImg" alt="@Model.Title" />
            <div class="thumbnail-list">
                @if (Model.ProductGalleries != null && Model.ProductGalleries.Any())
                {
                    foreach (var img in Model.ProductGalleries)
                    {
                        <img src="~/assets/img/product/@img.ImageName" onclick="changeMainImg(this.src)" />
                    }
                }
                else
                {
                    <img src="~/assets/img/product/@Model.ImageName" />
                }
            </div>
            
        </div>
        <div class="details-section">
            <div class="product-title">@Model.Title</div>
            <div class="label">دسته‌بندی: @Model.Category?.Name</div>
            <div class="short-desc">@Model.Description</div>
            <div class="pricing">
                @if (Model.Discount.HasValue && Model.Discount.Value > 0)
                {
                    <span class="old-price">@Model.Price تومان</span>
                    <span class="new-price">@((Model.Price - Model.Discount.Value)) تومان</span>
                }
                else
                {
                    <span class="new-price">@Model.Price تومان</span>
                }
            </div>
            <div class="stock">موجودی: @Model.Qty عدد</div>
            <form asp-action="AddToCart" asp-controller="Product" method="post">
                <input type="hidden" name="productId" value="@Model.Id" />
                <div class="quantity-control">
                    <button type="button" onclick="changeQty(1)">+</button>
                    <input type="number" id="qty" name="quantity" value="1" min="1" />
                    <button type="button" onclick="changeQty(-1)">−</button>
                </div>
                <button class="add-to-cart" type="submit">افزودن به سبد خرید</button>
            </form>
        </div>
        <!-- تب‌ها -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="active" onclick="showTab(0)">توضیحات بیشتر</button>
                <button onclick="showTab(1)">مشخصات فنی</button>
                <button onclick="showTab(2)">نظرات کاربران</button>
            </div>

            <div class="tab-content active">
                <p>@Model.Description</p>
            </div>
            <div class="tab-content">
                <p>
                    - تاریخ افزوده‌شدن: @Model.CreatedAt.ToString("yyyy/MM/dd") <br />
                    - شناسه محصول: @Model.Id
                </p>
            </div>
            <div class="tab-content">
                @if (comments != null && comments.Any())
                {
                    <ul class="list-group">
                        @foreach (var comment in comments)
                        {
                            <li class="list-group-item">
                                <strong>@comment.User?.UserName</strong> در تاریخ @comment.CreatedAt.ToString("yyyy/MM/dd HH:mm") نوشت:
                                <p>@comment.Text</p>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>هنوز نظری ثبت نشده است. شما اولین باشید!</p>
                }

                @if (User.Identity.IsAuthenticated)
                {
                    <form asp-action="AddComment" asp-controller="Product" method="post" class="mt-3">
                        <input type="hidden" name="productId" value="@Model.Id" />
                        <textarea name="text" class="form-control" rows="4" placeholder="نظر خود را بنویسید..." required ></textarea>
                        <button type="submit" class="btn btn-primary mt-2">ارسال نظر</button>
                    </form>
                }
                else
                {
                    <p class="text-muted mt-3">برای ارسال نظر لطفاً <a href="/User/Login">وارد شوید</a>.</p>
                }
            </div>
        </div>

      @*   <!-- محصولات مشابه -->
        @if (similarProducts != null && similarProducts.Any())
        {
            <div class="mahsolat">
                <h2>محصولات مشابه</h2>
                <div class="mahsolat-boxs">
                    @foreach (var p in similarProducts)
                    {
                        <div class="boxs">
                            <a href="/Product/Details/@p.Id">
                                <img src="~/assets/img/product/@p.ImageName" alt="@p.Title" />
                                <p>@p.Title</p>
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
 *@
    </div>

</div>

@section Scripts {
    <script>
        function changeQty(delta) {
            const qty = document.getElementById("qty");
            let current = parseInt(qty.value);
            if (isNaN(current)) current = 1;
            current += delta;
            if (current < 1) current = 1;
            qty.value = current;
        }

        function changeMainImg(src) {
            document.getElementById("mainImg").src = src;
        }

        function showTab(index) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-buttons button');
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
                buttons[i].classList.toggle('active', i === index);
            });
        }
    </script>
}
